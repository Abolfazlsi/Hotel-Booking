{% extends "base.html" %}
{% load static %}
{% load custom %}

{% block main %}
    <div class="container-fluid" dir="rtl">
        <div class="room-detail-container">
            <div class="row g-0">
                <!-- Room Gallery Section -->
                <div class="col-lg-6">
                    <div class="room-gallery">
                        <img src="{{ room.primary_image.image.url }}"
                             alt="اتاق هتل" class="main-image" id="mainImage" data-bs-toggle="modal"
                             data-bs-target="#imageModal">

                        <div class="thumbnail-gallery">
                            {% for image in room.images.all %}
                                <img src="{{ image.image.url }}" alt="نمای اتاق 1" class="thumbnail"
                                     onclick="changeMainImage(this)">
                            {% endfor %}


                        </div>
                    </div>
                </div>

                <!-- Room Information Section -->
                <div class="col-lg-6">
                    <div class="room-info">
                        <div class="room-badge__detail {% if room.existing %} existing {% else %} reserved {% endif %}">
                            {% if room.existing %}
                                موجود
                            {% else %}
                                رزرو شده
                            {% endif %}
                        </div>
                        <h1 class="room-title">{{ room.title }}</h1>
                        <div class="room-rating">
                            <div class="stars-title">
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                            </div>
                            <span class="rating-text">(4.8 از 5 - {{ room.reviews.count }} نظر)</span>
                        </div>
                        <p class="room-description">
                            {{ room.description }}
                        </p>

                        <div class="quick-info-cards">
                            <div class="info-card">
                                <div class="info-icon">
                                    <i class="fa fa-users"></i>
                                </div>
                                <div class="info-content">
                                    <span class="info-label">ظرفیت</span>
                                    <span class="info-value">{{ room.capacity }} نفر</span>
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="info-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="28" fill="currentColor"
                                         class="bi bi-arrows-fullscreen" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd"
                                              d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707m4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707m0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707m-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707"/>
                                    </svg>
                                </div>
                                <div class="info-content">
                                    <span class="info-label">مساحت</span>
                                    <span class="info-value">{{ room.size }} متر</span>
                                </div>
                            </div>
                        </div>

                        <!-- Amenities Section -->
                        <div class="amenities-section">

                            <h3 class="section-title__room-detail"><i class="fas fa-concierge-bell"></i>امکانات و خدمات:
                            </h3>
                            <div class="amenities-grid">
                                {% for service in room.services.all %}
                                    <div class="amenity-item">
                                        <span class="amenity-text">{{ service }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Pricing Section -->
                        <div class="pricing-section">
                            <div class="price-label">قیمت هر شب</div>
                            <div class="price-amount">{{ room.price|intcomma }}</div>
                            <div class="price-currency">تومان</div>
                        </div>

                        <button class="reserve-btn__room-detail" onclick="reserveRoom()">
                            رزرو اتاق
                        </button>
                    </div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="info-tabs-modern">
                        <ul class="nav nav-tabs modern-tabs" id="roomTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button
                                        class="nav-link active"
                                        id="description-tab"
                                        data-bs-toggle="tab"
                                        data-bs-target="#description"
                                        type="button"
                                        role="tab"
                                >
                                    <i class="fas fa-info-circle"></i>
                                    توضیحات کامل
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button
                                        class="nav-link"
                                        id="policies-tab"
                                        data-bs-toggle="tab"
                                        data-bs-target="#policies"
                                        type="button"
                                        role="tab"
                                >
                                    <i class="fas fa-file-contract"></i>
                                    قوانین
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button
                                        class="nav-link"
                                        id="reviews-tab"
                                        data-bs-toggle="tab"
                                        data-bs-target="#reviews"
                                        type="button"
                                        role="tab"
                                >
                                    <i class="fas fa-star"></i>
                                    نظرات ({{ room.reviews.count }})
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content modern-tab-content" id="roomTabsContent">
                            <!-- Description Tab -->
                            <div
                                    class="tab-pane fade show active"
                                    id="description"
                                    role="tabpanel"
                            >
                                <div class="tab-content-wrapper">
                                    <h4>درباره این اتاق</h4>
                                    <p>
                                        {{ room.description }}
                                    </p>

                                    <div class="features-grid">
                                        {% for service in room.services.all %}
                                            <div class="feature-item">
                                                <i class="fas fa-check-circle"></i>
                                                <span>{{ service }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Policies Tab -->
                            <div class="tab-pane fade" id="policies" role="tabpanel">
                                <div class="tab-content-wrapper">
                                    <div class="policies-grid">
                                        <div class="policy-item">
                                            <h5><i class="fa fa-clock"></i> ساعات ورود و خروج</h5>
                                            <p>ورود: از ساعت 14:00<br/>خروج: تا ساعت 12:00</p>
                                        </div>
                                        <div class="policy-item">
                                            <h5><i class="fa fa-ban"></i> قوانین لغو</h5>
                                            <p>
                                                لغو رایگان تا 24 ساعت قبل از ورود. پس از آن 50% هزینه
                                                کسر می‌شود.
                                            </p>
                                        </div>
                                        <div class="policy-item">
                                            <h5><i class="fa fa-paw"></i> حیوانات خانگی</h5>
                                            <p>حیوانات خانگی با هماهنگی قبلی پذیرفته می‌شوند.</p>
                                        </div>
                                        <div class="policy-item">
                                            <h5><i class="fa fa-smoking-ban"></i> سیگار</h5>
                                            <p>کشیدن سیگار در اتاق‌ها ممنوع است.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reviews Tab -->
                            <div class="tab-pane fade" id="reviews" role="tabpanel">
                                <div class="tab-content-wrapper">
                                    <div class="reviews-summary">
                                        <div class="rating-overview">
                                            <div class="rating-score">4.8</div>
                                            <div class="rating-details">
                                                <div class="stars-large">
                                                    <i class="fa fa-star"></i>
                                                    <i class="fa fa-star"></i>
                                                    <i class="fa fa-star"></i>
                                                    <i class="fa fa-star"></i>
                                                    <i class="fa fa-star"></i>
                                                </div>
                                                <div class="rating-count">بر اساس {{ room.reviews.count }} نظر</div>
                                            </div>
                                        </div>
                                        <div class="rating-breakdown">
                                            <div class="rating-bar">
                                                <span>5 ستاره</span>
                                                <div class="bar">
                                                    <div class="fill" style="width: 85%"></div>
                                                </div>
                                                <span>85%</span>
                                            </div>
                                            <div class="rating-bar">
                                                <span>4 ستاره</span>
                                                <div class="bar">
                                                    <div class="fill" style="width: 12%"></div>
                                                </div>
                                                <span>12%</span>
                                            </div>
                                            <div class="rating-bar">
                                                <span>3 ستاره</span>
                                                <div class="bar">
                                                    <div class="fill" style="width: 2%"></div>
                                                </div>
                                                <span>2%</span>
                                            </div>
                                            <div class="rating-bar">
                                                <span>2 ستاره</span>
                                                <div class="bar">
                                                    <div class="fill" style="width: 1%"></div>
                                                </div>
                                                <span>1%</span>
                                            </div>
                                            <div class="rating-bar">
                                                <span>1 ستاره</span>
                                                <div class="bar">
                                                    <div class="fill" style="width: 0%"></div>
                                                </div>
                                                <span>0%</span>
                                            </div>
                                        </div>
                                    </div>

                                    {% for review in room.reviews.all %}
                                        <div class="reviews-list">
                                            <div class="review-item">
                                                <div class="reviewer-info">
                                                    <div class="reviewer-details">
                                                        <h6>{{ review.user.first_name }} {{ review.user.last_name }}</h6>
                                                        <div class="review-stars">
                                                            {% for i in "x"|ljust:review.rating %}
                                                                <i class="fa fa-star"></i>
                                                            {% endfor %}
                                                        </div>
                                                        <span class="review-date">{{ review.time_since_creation }}</span>
                                                    </div>
                                                </div>
                                                <p class="review-text">
                                                    {{ review.comment }}
                                                </p>
                                            </div>

                                        </div>
                                    {% endfor %}

                                    <!-- Add Review Form -->
                                    <div class="add-review-section">
                                        <h5>نظر خود را بنویسید</h5>
                                        <form class="review-form">
                                            <div class="form-group">
                                                <label>امتیاز شما</label>
                                                <div class="rating-input">
                                                    <i class="far fa-star star" data-rating="1"></i>
                                                    <i class="far fa-star star" data-rating="2"></i>
                                                    <i class="far fa-star star" data-rating="3"></i>
                                                    <i class="far fa-star star" data-rating="4"></i>
                                                    <i class="far fa-star star" data-rating="5"></i>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label>نظر شما</label>
                                                <textarea
                                                        class="form-control"
                                                        rows="4"
                                                        required
                                                ></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                ارسال نظر
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Back to Top Button -->
    <div class="back-to-top" id="backToTop">
        <i class="fa fa-chevron-up"></i>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">تصاویر اتاق</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/FireShot%20Capture%20002%20-%20%D9%BE%DB%8C%D8%B4%D9%86%D9%85%D8%A7%DB%8C%D8%B4%20%D9%82%D8%A7%D9%84%D8%A8%20%D8%B1%D8%B2%D8%B1%D9%88%20%D9%87%D8%AA%D9%84%D8%8C%20Hotel%20-%20%D8%B1%D8%A7%D8%B3%D8%AA%20%DA%86%DB%8C%D9%86%20-%20%5Brtlr.ir%5D.jpg-KAfkcm3aunpRjEDYU1jAvBiydEiLMy.jpeg"
                         alt="تصویر اتاق" class="modal-image" id="modalImage">
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content booking-modal-content">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="bookingForm" class="booking-form">
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="booking-label">تاریخ خروج:</label>
                                <input type="date" class="form-control__room-detail booking-input" id="checkoutDate"
                                       required>
                            </div>
                            <div class="col-md-6">
                                <label class="booking-label">تاریخ ورود:</label>
                                <input type="date" class="form-control__room-detail booking-input" id="checkinDate"
                                       required>
                            </div>
                        </div>
                        {% for i in "x"|ljust:room.capacity %}
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="booking-label">جنسیت</label>
                                    <select class="form-control__room-detail booking-input" name="gender">
                                        <option value="مرد">مرد</option>
                                        <option value="زن">زن</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="booking-label">نام کامل شخص {{ forloop.counter }}:</label>
                                    <input type="text" class="form-control__room-detail booking-input"
                                           placeholder="نام کامل" required>
                                </div>
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="booking-label">کد ملی:</label>
                                    <input type="text" class="form-control__room-detail booking-input"
                                           placeholder="کد ملی"
                                           maxlength="10" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="booking-label">شماره تلفن:</label>
                                    <input type="tel" class="form-control__room-detail booking-input"
                                           placeholder="شماره تلفن" required>
                                </div>
                            </div>
                        {% endfor %}
                        <div class="text-start">
                            <button type="submit" class="btn payment-btn">
                                پرداخت
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('active');
        }

        // Change main image when thumbnail is clicked
        function changeMainImage(thumbnail) {
            const mainImage = document.getElementById('mainImage');
            const modalImage = document.getElementById('modalImage');

            // Remove active class from all thumbnails
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });

            // Add active class to clicked thumbnail
            thumbnail.classList.add('active');

            // Change main image source
            mainImage.src = thumbnail.src;
            modalImage.src = thumbnail.src;

            // Add animation effect
            mainImage.style.opacity = '0';
            setTimeout(() => {
                mainImage.style.opacity = '1';
            }, 150);
        }

        // Reserve room function - show booking modal
        function reserveRoom() {
            const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
            bookingModal.show();
        }

        // Star rating functionality
        let selectedRating = 0;
        const stars = document.querySelectorAll('.star');

        stars.forEach(star => {
            star.addEventListener('click', function () {
                selectedRating = parseInt(this.getAttribute('data-rating'));
                updateStarDisplay();
            });

            star.addEventListener('mouseover', function () {
                const hoverRating = parseInt(this.getAttribute('data-rating'));
                highlightStars(hoverRating);
            });
        });

        document.getElementById('starRating').addEventListener('mouseleave', function () {
            updateStarDisplay();
        });

        function updateStarDisplay() {
            stars.forEach((star, index) => {
                if (index < selectedRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function highlightStars(rating) {
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // Comment form submission
        document.getElementById('commentForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const name = this.querySelector('input[type="text"]').value;
            const email = this.querySelector('input[type="email"]').value;
            const comment = this.querySelector('textarea').value;

            // Validation
            if (!name || !email || !comment) {
                alert('لطفاً تمام فیلدها را پر کنید.');
                return;
            }

            if (selectedRating === 0) {
                alert('لطفاً امتیاز خود را انتخاب کنید.');
                return;
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('لطفاً یک آدرس ایمیل معتبر وارد کنید.');
                return;
            }

            // Show loading state
            const submitBtn = this.querySelector('.submit-comment-btn');
            const originalText = submitBtn.textContent;

            submitBtn.textContent = 'در حال ارسال...';
            submitBtn.disabled = true;

            // Simulate comment submission
            setTimeout(() => {
                alert(`نظر شما با موفقیت ثبت شد!\nنام: ${name}\nامتیاز: ${selectedRating} ستاره\nنظر: ${comment}`);

                // Reset form
                this.reset();
                selectedRating = 0;
                updateStarDisplay();

                submitBtn.textContent = originalText;
                submitBtn.disabled = false;

                // Update no comments message
                document.querySelector('.no-comments').textContent = 'نظر شما در انتظار تایید است.';
            }, 2000);
        });

        // Add smooth scroll animation for amenities
        const amenityItems = document.querySelectorAll('.amenity-item');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry, index) => {
                if (entry.isIntersecting) {
                    setTimeout(() => {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }, index * 100);
                }
            });
        });

        amenityItems.forEach(item => {
            item.style.opacity = '0';
            item.style.transform = 'translateY(20px)';
            item.style.transition = 'all 0.5s ease';
            observer.observe(item);
        });

        // Add ripple effect to buttons
        document.querySelectorAll('.reserve-btn, .submit-comment-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                const ripple = document.createElement('span');
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;

                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                ripple.classList.add('ripple');

                this.appendChild(ripple);

                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        });


        // Booking form submission
        document.getElementById('bookingForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const checkinDate = document.getElementById('checkinDate').value;
            const checkoutDate = document.getElementById('checkoutDate').value;
            const fullName = this.querySelector('input[placeholder="نام کامل"]').value;
            const guestCount = this.querySelector('select').value;
            const nationalId = this.querySelector('input[placeholder="کد ملی"]').value;
            const phoneNumber = this.querySelector('input[type="tel"]').value;

            // Validation
            if (!checkinDate || !checkoutDate || !fullName || !nationalId || !phoneNumber) {
                alert('لطفاً تمام فیلدها را پر کنید.');
                return;
            }

            // Date validation
            const checkin = new Date(checkinDate);
            const checkout = new Date(checkoutDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (checkin < today) {
                alert('تاریخ ورود نمی‌تواند از امروز کمتر باشد.');
                return;
            }

            if (checkout <= checkin) {
                alert('تاریخ خروج باید بعد از تاریخ ورود باشد.');
                return;
            }

            // National ID validation (10 digits)
            if (!/^\d{10}$/.test(nationalId)) {
                alert('کد ملی باید ۱۰ رقم باشد.');
                return;
            }

            // Phone number validation
            if (!/^09\d{9}$/.test(phoneNumber)) {
                alert('شماره تلفن باید با ۰۹ شروع شده و ۱۱ رقم باشد.');
                return;
            }

            // Show loading state
            const submitBtn = this.querySelector('.payment-btn');
            const originalText = submitBtn.textContent;

            submitBtn.textContent = 'در حال پردازش...';
            submitBtn.disabled = true;

            // Calculate nights
            const nights = Math.ceil((checkout - checkin) / (1000 * 60 * 60 * 24));
            const totalPrice = nights * 30500000; // Price per night

            // Simulate booking process
            setTimeout(() => {
                alert(`رزرو شما با موفقیت ثبت شد!\n\nجزئیات رزرو:\nنام: ${fullName}\nتاریخ ورود: ${checkinDate}\nتاریخ خروج: ${checkoutDate}\nتعداد مهمان: ${guestCount}\nتعداد شب: ${nights}\nمبلغ کل: ${totalPrice.toLocaleString()} ریال\n\nبه زودی با شما تماس خواهیم گرفت.`);

                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
                modal.hide();
                this.reset();

                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }, 2000);
        });

        // Set minimum date to today for check-in
        document.getElementById('checkinDate').min = new Date().toISOString().split('T')[0];

        // Update checkout minimum date when checkin changes
        document.getElementById('checkinDate').addEventListener('change', function () {
            const checkinDate = new Date(this.value);
            checkinDate.setDate(checkinDate.getDate() + 1);
            document.getElementById('checkoutDate').min = checkinDate.toISOString().split('T')[0];
        });

        // Back to top button functionality
        const backToTopBtn = document.getElementById('backToTop');

        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                backToTopBtn.classList.add('visible');
            } else {
                backToTopBtn.classList.remove('visible');
            }
        });

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', function (e) {

        });
    </script>

{% endblock %}