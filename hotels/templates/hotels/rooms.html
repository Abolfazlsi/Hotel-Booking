{% extends "base.html" %}
{% load static %}
{% load custom_filter %}

{% block main %}
    <!-- Page Title Section -->
    <section class="page-title-section" dir="rtl">
        <div class="container" dir="rtl">
            <h1 class="page-title">اتاق‌ها</h1>
            <p class="page-subtitle">انتخاب بهترین اتاق برای اقامت شما</p>
        </div>
    </section>

    <!-- Rooms List Section -->
    <section class="rooms-list-section" dir="rtl">
        <div class="container">
            <div class="row">
                <!-- Main Content -->
                <div class="col-lg-8 order-lg-1 order-2">
                    <!-- Sort Filter Bar -->
                    <div class="sort-filter-bar">
                        <div class="sort-label">مرتب‌سازی بر اساس:</div>
                        <div class="sort-options" id="sortOptions">
                            <div class="sort-option active" data-sort="default">پیش‌فرض</div>
                            <div class="sort-option" data-sort="lower-price">قیمت صعودی</div>
                            <div class="sort-option" data-sort="higher-price">قیمت نزولی</div>
                        </div>
                    </div>

                    <!-- Room Cards -->
                    <div class="rooms-container" id="roomsContainer">
                        <!-- Skeleton Loader -->
                        <div class="skeleton-loader" id="roomsLoader">
                            <div class="skeleton-card">
                                <div class="skeleton-card-inner">
                                    <div class="skeleton-image"></div>
                                    <div class="skeleton-content">
                                        <div class="skeleton-title"></div>
                                        <div class="skeleton-price"></div>
                                        <div class="skeleton-amenities">
                                            <div class="skeleton-amenity"></div>
                                            <div class="skeleton-amenity"></div>
                                            <div class="skeleton-amenity"></div>
                                        </div>
                                        <div class="skeleton-description"></div>
                                        <div class="skeleton-button"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="skeleton-card">
                                <div class="skeleton-card-inner">
                                    <div class="skeleton-image"></div>
                                    <div class="skeleton-content">
                                        <div class="skeleton-title"></div>
                                        <div class="skeleton-price"></div>
                                        <div class="skeleton-amenities">
                                            <div class="skeleton-amenity"></div>
                                            <div class="skeleton-amenity"></div>
                                            <div class="skeleton-amenity"></div>
                                        </div>
                                        <div class="skeleton-description"></div>
                                        <div class="skeleton-button"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12" dir="rtl">
                        {% if page_obj.has_other_pages %}
                            <div class="room-pagination" id="pagination">
                                {% if page_obj.has_previous %}
                                    <a href="?page={{ page_obj.previous_page_number }}"><i
                                            class="fa fa-long-arrow-left"></i></a>
                                {% endif %}

                                {% if page_obj.number|add:-2 > 1 %}
                                    <a href="?page=1">1</a>
                                    {% if page_obj.number|add:-2 > 2 %}
                                        <span>...</span>
                                    {% endif %}
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                    {% if num >= page_obj.number|add:-2 and num <= page_obj.number|add:2 %}
                                        <a href="?page={{ num }}"
                                           {% if page_obj.number == num %}class="active"{% endif %}>{{ num }}</a>
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.number|add:2 < page_obj.paginator.num_pages %}
                                    {% if page_obj.number|add:3 < page_obj.paginator.num_pages %}
                                        <span>...</span>
                                    {% endif %}
                                    <a href="?page={{ page_obj.paginator.num_pages }}">{{ page_obj.paginator.num_pages }}</a>
                                {% endif %}

                                {% if page_obj.has_next %}
                                    <a href="?page={{ page_obj.next_page_number }}"><i
                                            class="fa fa-long-arrow-right"></i></a>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Filter Sidebar -->
                <div class="col-lg-4 order-lg-2 order-1">
                    <div class="filter-sidebar">
                        <h3 class="filter-title">فیلترها</h3>
                        <div class="filter-results-count" id="resultsCount" style="display: none;">
                            <i class="fa fa-check-circle"></i>
                            <span id="resultsNumber">0</span> اتاق یافت شد
                        </div>
                        <form method="get" action="{% url 'hotels:rooms_list' %}">
                            <!-- Date Filters -->
                            <div class="filter-group">
                                <h4 class="filter-group-title">تاریخ</h4>
                                <div class="filter-content">
                                    <div class="mb-3">
                                        <label for="{{ search_form.check_in.id_for_label }}" class="booking-label">تاریخ
                                            ورود:</label>
                                        {{ search_form.check_in }}
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ search_form.check_out.id_for_label }}" class="booking-label">تاریخ
                                            خروج:</label>
                                        {{ search_form.check_out }}
                                    </div>
                                </div>
                            </div>
                            <!-- Number of People Filter -->
                            <div class="filter-group">
                                <h4 class="filter-group-title">تعداد نفرات</h4>
                                <div class="filter-content">
                                    <div class="people-counter">
                                        <button type="button" class="counter-btn minus-btn">
                                            <i class="fa fa-minus"></i>
                                        </button>
                                        <span class="counter-value" id="peopleCount">۲</span>
                                        <input type="hidden" name="people_count" id="people_count" value="2">
                                        <button type="button" class="counter-btn plus-btn">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Price Range Filter -->
                            <div class="filter-group">
                                <h4 class="filter-group-title">قیمت برای هر شب</h4>
                                <div class="price-range">
                                    <div class="price-slider">
                                        <div class="price-progress"></div>
                                    </div>
                                    <div class="price-range-input">
                                        <input type="range" min="500000" max="10000000" value="2500000"
                                               class="min-price">
                                        <input type="range" min="500000" max="10000000" value="7500000"
                                               class="max-price">
                                    </div>
                                    <div class="price-values">
                                        <div class="price-value min-value">۵۰۰,۰۰۰</div>
                                        <div class="price-value max-value">۱۰,۰۰۰,۰۰۰</div>
                                    </div>
                                </div>
                                <input type="hidden" name="min_price" id="min_price" value="500000">
                                <input type="hidden" name="max_price" id="max_price" value="10000000">
                            </div>
                            <!-- Apply Filter Button -->
                            <button type="submit" class="apply-filter-btn">اعمال فیلتر</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const sortOptions = document.querySelectorAll('#sortOptions .sort-option');
            const sortOptionsContainer = document.getElementById("sortOptions");
            const roomsContainer = document.getElementById('roomsContainer');
            const pagination = document.getElementById('pagination');
            const peopleCount = document.getElementById('peopleCount');
            const peopleCountInput = document.getElementById('people_count');
            const minPriceInput = document.querySelector('.min-price');
            const maxPriceInput = document.querySelector('.max-price');
            const applyFilterBtn = document.querySelector('.apply-filter-btn');
            const roomsLoader = document.getElementById('roomsLoader');
            const resultsCount = document.getElementById('resultsCount');
            const resultsNumber = document.getElementById('resultsNumber');
            let currentSort = 'default';
            let currentPage = 1;
            let abortController = null;


            jalaliDatepicker.startWatch({
                minDate: 'today',
            });

            function truncateWords(text, wordLimit) {
                const words = text.split(' ');
                if (words.length > wordLimit) {
                    return words.slice(0, wordLimit).join(' ') + '...';
                }
                return text;
            }

            function loadRooms(sort = 'default', page = 1, filters = {}) {
                if (abortController) {
                    abortController.abort();
                }
                abortController = new AbortController();

                const existingCards = roomsContainer.querySelectorAll('.room-card');
                existingCards.forEach(card => card.remove());

                roomsLoader.classList.add('show');
                roomsContainer.classList.add('loading');

                const params = new URLSearchParams({
                    sort: sort,
                    page: page,
                    check_in: filters.check_in || '',
                    check_out: filters.check_out || '',
                    people: filters.people || '',
                    min_price: filters.min_price || '',
                    max_price: filters.max_price || ''
                }).toString();

                window.history.pushState({sort, page, filters}, '', `?${params}`);

                fetch(`?${params}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    signal: abortController.signal,
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        }
                        throw new Error('Request failed');
                    })
                    .then(data => {
                        roomsLoader.classList.remove('show');
                        roomsContainer.classList.remove('loading');

                        if (data.total_rooms !== undefined) {
                            resultsNumber.textContent = convertToPersianNumbers(data.total_rooms);
                            resultsCount.style.display = 'block';
                        }

                        // گرفتن تاریخ‌ها برای اضافه کردن به لینک رزرو
                        const checkIn = filters.check_in || '';
                        const checkOut = filters.check_out || '';

                        const roomCardsHtml = data.room_list.map(room => `
                <div class="room-card fade-in-delay">
                    <div class="room-card-inner">
                        <div class="room-image-container">
                            <img src="${room.image_url}" alt="${room.alt_text}" class="room-image">
                            <div class="room-badge ${room.existing}">
                                ${room.existing_text}
                            </div>
                        </div>
                        <div class="room-content">
                            <div class="room-header">
                                <h3 class="room-title">${room.title}</h3>
                                <div class="room-price-container">
                                    <div class="room-price">${room.price.toLocaleString()}</div>
                                    <span class="room-price-currency">تومان</span>
                                </div>
                            </div>
                            <div class="room-amenities">
                                ${room.services.map(service => `<div class="amenity-badge">${service}</div>`).join('')}
                            </div>
                            <div class="room-description">
                                <h5>توضیحات:</h5>
                                <p>${truncateWords(room.description, 25)}</p>
                            </div>
                            <div class="room-footer">
                                <a href="${room.url}?check_in=${encodeURIComponent(checkIn)}&check_out=${encodeURIComponent(checkOut)}">
                                    <button class="reserve-btn">رزرو</button>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

                        roomsContainer.insertAdjacentHTML('beforeend', roomCardsHtml);

                        let paginationHtml = '';
                        if (data.has_previous) {
                            paginationHtml += `<a href="#" data-page="${data.previous_page_number}"><i class="fa fa-long-arrow-left"></i></a>`;
                        }
                        if (data.current_page - 2 > 1) {
                            paginationHtml += `<a href="#" data-page="1">1</a>`;
                            if (data.current_page - 2 > 2) paginationHtml += '<span>...</span>';
                        }
                        for (let num = data.current_page - 2; num <= data.current_page + 2; num++) {
                            if (num >= 1 && num <= data.total_pages) {
                                paginationHtml += `<a href="#" data-page="${num}" ${data.current_page === num ? 'class="active"' : ''}>${num}</a>`;
                            }
                        }
                        if (data.current_page + 2 < data.total_pages) {
                            if (data.current_page + 3 < data.total_pages) paginationHtml += '<span>...</span>';
                            paginationHtml += `<a href="#" data-page="${data.total_pages}">${data.total_pages}</a>`;
                        }
                        if (data.has_next) {
                            paginationHtml += `<a href="#" data-page="${data.next_page_number}"><i class="fa fa-long-arrow-right"></i></a>`;
                        }
                        pagination.innerHTML = paginationHtml;

                        document.querySelectorAll('#pagination a').forEach(link => {
                            link.addEventListener('click', function (e) {
                                e.preventDefault();
                                const page = this.getAttribute('data-page');
                                currentPage = page;
                                loadRooms(currentSort, page, getFilters());
                                window.scrollTo({
                                    top: 0,
                                    behavior: 'smooth'
                                });
                            });
                        });
                    })
                    .catch(error => {
                        if (error.name === 'AbortError') {
                            console.log('Request was aborted');
                            return;
                        }
                        console.error('Error:', error);
                        roomsLoader.classList.remove('show');
                        roomsContainer.classList.remove('loading');
                    })
                    .finally(() => {
                        abortController = null;
                    });
            }

            function getFilters() {
                const checkIn = document.getElementById('check_in') ? document.getElementById('check_in').value : '';
                const checkOut = document.getElementById('check_out') ? document.getElementById('check_out').value : '';
                const people = peopleCountInput.value;
                const minPrice = document.getElementById('min_price') ? document.getElementById('min_price').value : '';
                const maxPrice = document.getElementById('max_price') ? document.getElementById('max_price').value : '';
                return {
                    check_in: checkIn,
                    check_out: checkOut,
                    people: people,
                    min_price: minPrice,
                    max_price: maxPrice
                };
            }

            sortOptions.forEach(option => {
                option.addEventListener('click', function () {
                    sortOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    currentSort = this.getAttribute('data-sort');
                    currentPage = 1;
                    loadRooms(currentSort, currentPage, getFilters());

                    sortOptionsContainer.style.pointerEvents = "none";
                    setTimeout(() => {
                        sortOptionsContainer.style.pointerEvents = "auto";
                    }, 3000);
                });
            });

            const minusBtn = document.querySelector('.minus-btn');
            const plusBtn = document.querySelector('.plus-btn');
            let peopleCountValue = 2;

            minusBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (peopleCountValue > 1) {
                    peopleCountValue--;
                    peopleCount.textContent = convertToPersianNumbers(peopleCountValue);
                    peopleCountInput.value = peopleCountValue;
                }
            });

            plusBtn.addEventListener('click', () => {
                if (peopleCountValue < 10) {
                    peopleCountValue++;
                    peopleCount.textContent = convertToPersianNumbers(peopleCountValue);
                    peopleCountInput.value = peopleCountValue;
                }
            });

            const rangeInput = document.querySelectorAll(".price-range-input input");
            const progress = document.querySelector(".price-progress");
            const minValue = document.querySelector(".min-value");
            const maxValue = document.querySelector(".max-value");

            rangeInput.forEach(input => {
                input.addEventListener('input', (e) => {
                    let minVal = parseInt(rangeInput[0].value);
                    let maxVal = parseInt(rangeInput[1].value);

                    if (maxVal - minVal < 500000) {
                        if (e.target.className === "min-price") {
                            rangeInput[0].value = maxVal - 500000;
                        } else {
                            rangeInput[1].value = minVal + 500000;
                        }
                    } else {
                        progress.style.right = (minVal / rangeInput[0].max) * 100 + "%";
                        progress.style.left = 100 - (maxVal / rangeInput[1].max) * 100 + "%";
                        minValue.textContent = formatPrice(minVal);
                        maxValue.textContent = formatPrice(maxVal);


                        if (document.getElementById('min_price')) {
                            document.getElementById('min_price').value = minVal;
                        }
                        if (document.getElementById('max_price')) {
                            document.getElementById('max_price').value = maxVal;
                        }
                    }
                });
            });

            applyFilterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                applyFilterBtn.disabled = true;
                setTimeout(() => {
                    applyFilterBtn.disabled = false;
                }, 3000);
                currentPage = 1;
                loadRooms(currentSort, currentPage, getFilters());
            });

            function convertToPersianNumbers(num) {
                const persianDigits = ["۰", "۱", "۲", "۳", "۴", "۵", "۶", "۷", "۸", "۹"];
                return num.toString().replace(/\d/g, (x) => persianDigits[x]);
            }

            function formatPrice(price) {
                return convertToPersianNumbers(price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
            }

            loadRooms(currentSort, currentPage, getFilters());

            document.querySelectorAll(".filter-group-title").forEach(title => {
                title.addEventListener("click", function () {
                    const content = this.nextElementSibling;
                    if (content.style.display === "none" || !content.style.display) {
                        content.style.display = "block";
                        this.classList.remove("collapsed");
                    } else {
                        content.style.display = "none";
                        this.classList.add("collapsed");
                    }
                });
            });
        });
    </script>
{% endblock %}